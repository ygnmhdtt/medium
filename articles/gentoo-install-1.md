---
title: "ThinkPadE470にGentooをインストールした その1"
date: 2017-12-26T10:49:31+09:00
tags:
- Gentoo
---

ThinkPad E470にGentooをインストールしたログ。

<!--more-->

### はじめに
基本的に[公式ハンドブック](https://wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation)を参照しながら進めた。

### インストールの流れ
インストールの流れを示す。筆者はとりあえず最後までの流れを理解しないと不安で始められないため。

1. インストールメディアを作成する
2. インストールメディアを起動する
3. マシンをインターネットに繋ぐ
4. パーティショニングして、ファイルシステムを作成する
5. tarballをダウンロードし、展開する
6. tarballを展開したディレクトリにchrootする
7. portageをセットアップする
8. カーネルをビルドする
9. ブートローダをセットアップする
10. Gentooが起動することを確認する

このエントリーでは5まで書く。

### 1. インストールメディアを作成する

USBメモリにインストールメディアを作成する。
インストールメディアの中には小さいOSが入っている。しかし、インストールメディアを起動しても、操作できるのは当然インストールメディアの中だけ。
そこで、マシンのハードディスクをインストールメディアにマウントし、インストールメディア経由でマシンを操作する。これにより、何も入ってないマシンにGentooをインストールできる。というのが、インストールメディアが必要な理由。
(マウントとはなにか、についてはググってください。)

今回はUSBメモリをメディアとした。
以下の操作はWindows上で行っている。
[SystemRescueCdのISO](http://www.system-rescue-cd.org/Download/)をダウンロードする。
そして、[Rufus](https://rufus.akeo.ie/)のexeファイルをダウンロードする。
Rufusを起動し、ビックカメラで買ってきたUSBメモリ(16GB(たぶんこんなにいらない))をマシンに挿す。
Rufusの画面から、パーティション構成をGPTに設定してスタートする。たぶんなにも起きないはず。

### 2. インストールメディアを起動する

Windows10では `高速スタートアップ` という機能があり、メディアからの起動ができないので、[こちら](http://121ware.com/qasearch/1007/app/servlet/relatedqa?QID=018214)を参考に無効にする。
そして、 `スタート` -> 電源のマークを押す -> `Shift` を押しながら再起動をクリックし、電源を切る。
USBを挿す。
あと、SecureBootを無効にしないといけないらしいので、UEFIの設定画面に入る。
筆者のマシンでは、電源ボタンを押した後Enterキーを連打し、その後 `F1` を押すことで設定画面に入れたが、マシンのメーカーによって違うと思う。
`SecureBoot` を `Disabled` にする。
再度Rebootして、Enter連打の後 `F12` を押して、USBメモリを選択する。
SystemRescueCD内のgrubが起動するので、一番上を選択する。
これでインストールメディアが起動する。

### 3. インターネットに繋ぐ

これはハンドブックに載っていたやり方だとダメだった。
筆者の家は有線LAN環境がないため、無線でつなぎたかったが、ハンドブックのやり方ではWEPの無線にのみ対応している。
最近WEPとかあんまり使ってないと思う。
WPAでのつなぎ方は[こちら](https://yaginumahidetatsu.com/2017/12/24/wpa_supplicant/)に書いた。

### 4. パーティショニングして、ファイルシステムを作成する

パーティショニングは、ハードディスクを分割すること。
したがって、どう分割するかを設計する必要がある。
ディスク容量や用途にもよるので一概には言えないが、筆者は以下のように切った。

|デバイス|容量|ファイルシステム|用途|
|:---|:---|:---|:---|
|sda1|512MB|vfat|ブートローダ|
|sda2|1024MB| - |スワップ|
|sda3|残り全部|ext4|Gentoo|

注意点としては、

* 物理メモリが潤沢にある環境であれば、スワップは別になくても良い
* sda1(ハードディスクの先頭セクタ)にブートローダが必要(ないとGentooが起動できない)
くらいか…

後、パーティションの切り方はいろんなやり方がある。
ググると `fdisk` `gdisk` `parted` などがあるが、結局使用目的は同じなので、どれを使っても良い。
筆者はgdiskで切った。ツールの使い方はどうでもいいのでググってください。
partedは変更が即反映されるのであんまりおすすめできない。
gdiskは保存するまではなにも起きない。

そして、ファイルシステムを作る。
ファイルシステムがあることで、我々はデータをファイルとして認識できる。
ポイントは、ブート用のパーティションは `vfat` で作るということ。
Gentoo用のパーティションはよっぽどこだわりがなければext4で良いと思う。

```
# ブートパーティション
% mkfs.vfat /dev/sda1

# Gentooパーティション
% mkfs.ext4 /dev/sda3

# スワップパーティション
% mkswap /dev/sda2
% swapon /dev/sda2
```

### 5. tarballをダウンロードし、展開する。
前述の通り、今はUSBメディアの中で作業している。
しかし、Gentooをインストールしたいのはさっき切った `/dev/sda3` なので。
USBから `/dev/sda3` を見られるようにしないといけない。なので、マウントする。

```
% mount /dev/sda3 /mnt/gentoo
```

/mnt/gentooというディレクトリが用意されているので、そこにマウントする。
ついでに、 `/dev/sda1` もマウントしておく。
Linuxでは `/boot` にブート用のファイルが格納されるので、

```
% mkdir /mnt/gentoo/boot
% mount /dev/sda1 /mnt/gentoo/boot
```

のようにする。

そしてtarballをインストールする。
tarballは、Gentooとしての最低限のツールが入ったもの。
SystemRescueCDには `links` コマンドがないため、以下のようにする。

```
% cd /mnt/gentoo
% elinks https://www.gentoo.org/downloads/mirrors/
```

ミラーを選ぶ。
筆者はIIJさんのサーバから、 `http://ftp.iij.ad.jp/pub/linux/gentoo/releases/amd64/autobuilds/20171215T184104Z/stage3-amd64-20171215T184104Z.tar.bz2` をもらった。

ダウンロードが終わったら展開する。

```
% tar xvjpf stage3-*.tar.bz2 --xattrs --numeric-owner
```

続きは[こちら](https://yaginumahidetatsu.com/2017/12/26/gentoo-install-2/)。

